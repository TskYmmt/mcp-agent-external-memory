# MCP Server開発依頼: 自律型調査データ蓄積サーバー

## 背景と目的
AIエージェントが調査を実施した際に、その場で調査結果を保存するための最適なデータベース構造を設計し、
データベースとテーブルを自動作成し、調査結果を自律的に蓄積していくためのMCPサーバーを開発してください。

**重要**: このMCPサーバーは調査機能自体は持ちません。調査はAIエージェントが別のツール（Web検索など）で実施します。
このサーバーは**調査結果の保存・管理に特化**したデータベース操作ツールです。

## コアコンセプト
「AIが調査内容に応じて最適なデータ構造を判断 → DB/テーブルを動的に作成 → 調査結果を蓄積 → 検索・分析可能」
という完全自律型のデータ管理ワークフローを実現することが目的です。

## 技術仕様

### 使用技術
- 言語: Python
- フレームワーク: FastMCP (from mcp.server.fastmcp)
- データベース: SQLite (シンプルで自己完結型)
- パッケージマネージャ: uv

### 必要なツール（7つ）

#### 1. create_research_database
- **説明**: 調査結果を保存するための新しいデータベースとテーブルを作成
- **パラメータ**:
  - `database_name` (str): データベース名（調査テーマに基づく）
  - `table_schema` (dict): テーブル定義
    ```python
    {
      "table_name": "market_research_results",
      "columns": {
        "id": "INTEGER PRIMARY KEY AUTOINCREMENT",
        "research_date": "TEXT",
        "company_name": "TEXT",
        "industry": "TEXT",
        "market_cap": "REAL",
        "findings": "TEXT"
      }
    }
    ```
  - `description` (str): このデータベースの目的・説明
- **動作**:
  - 指定されたデータベースファイルを作成（存在しない場合）
  - テーブルを作成
  - メタデータテーブルに作成情報を記録
- **戻り値**: 作成成功メッセージとDBパス、テーブル名

#### 2. insert_research_data
- **説明**: 調査結果データをデータベースに挿入
- **パラメータ**:
  - `database_name` (str): 対象データベース
  - `table_name` (str): 対象テーブル
  - `data` (dict | list[dict]): 挿入するデータ（単一行または複数行）
    ```python
    # 単一行の例
    {"company_name": "Apple Inc.", "industry": "Technology", "market_cap": 3000000000000}
    
    # 複数行の例
    [
      {"company_name": "Apple Inc.", ...},
      {"company_name": "Microsoft Corp.", ...}
    ]
    ```
- **動作**:
  - データの型チェック
  - INSERT文を動的に生成して実行
  - トランザクション管理
- **戻り値**: 挿入された行数とステータス

#### 3. query_research_data
- **説明**: 蓄積された調査データを検索・分析
- **パラメータ**:
  - `database_name` (str): 対象データベース
  - `sql_query` (str): SELECT文（AIが生成）
    ```sql
    SELECT * FROM market_research_results 
    WHERE industry = 'Technology' 
    ORDER BY market_cap DESC 
    LIMIT 10
    ```
- **動作**:
  - クエリの安全性チェック（SELECT以外は拒否）
  - クエリ実行
  - 結果を構造化して返却
- **戻り値**: クエリ結果（JSON形式のリスト）

#### 4. list_research_databases
- **説明**: 既存の調査データベース一覧を取得
- **パラメータ**: なし
- **動作**:
  - 作成済みのすべての.dbファイルをリスト
  - 各DBのメタデータ（作成日時、テーブル数、説明）を取得
- **戻り値**: データベース一覧と詳細情報

#### 5. get_table_schema
- **説明**: テーブルのスキーマ情報を取得（追加データ挿入時に必要）
- **パラメータ**:
  - `database_name` (str): 対象データベース
  - `table_name` (str): 対象テーブル
- **動作**:
  - SQLiteのPRAGMA文でスキーマ取得
  - カラム名、型、制約情報を整理
- **戻り値**: カラム情報の詳細（名前、型、NULL許可、デフォルト値など）

#### 6. list_all_databases
- **説明**: MCPサーバーが管理するすべてのデータベースファイルを一覧表示
- **パラメータ**: なし
- **動作**:
  - `research_databases/` ディレクトリ内のすべての.dbファイルをスキャン
  - 各DBファイルについて以下の情報を取得:
    - ファイル名
    - ファイルサイズ
    - 作成日時
    - 最終更新日時
    - メタデータテーブルから説明文を取得（存在する場合）
    - 含まれるテーブル数とテーブル名リスト
- **戻り値**: データベース情報の配列
  ```python
  [
    {
      "database_name": "tech_giants_2025.db",
      "size_mb": 2.5,
      "created_at": "2025-01-15 10:30:00",
      "updated_at": "2025-01-15 14:20:00",
      "description": "GAFAM企業の時価総額調査",
      "tables": ["companies", "market_data"]
    },
    ...
  ]
  ```

#### 7. delete_database
- **説明**: 指定したデータベースファイルを完全に削除（危険な操作のため慎重に）
- **パラメータ**:
  - `database_name` (str): 削除対象のデータベース名
  - `confirm` (bool): 削除確認フラグ（trueの場合のみ実行）
- **動作**:
  1. `confirm` が `false` の場合、削除せずに警告メッセージを返す
  2. `confirm` が `true` の場合:
     - データベースファイルの存在確認
     - データベースの内容（テーブル数、レコード数）をログ出力
     - ファイルを完全削除
     - 削除完了メッセージを返す
- **戻り値**: 削除結果メッセージ
  ```python
  # confirm=false の場合
  {
    "status": "confirmation_required",
    "message": "データベース 'tech_giants_2025.db' を削除します。この操作は取り消せません。削除するには confirm=true を指定してください。",
    "database_info": {...}
  }
  
  # confirm=true の場合
  {
    "status": "deleted",
    "message": "データベース 'tech_giants_2025.db' を削除しました。",
    "deleted_file": "/path/to/tech_giants_2025.db"
  }
  ```
- **注意事項**:
  - この操作は元に戻せないため、必ず2段階確認を実装
  - 削除前にデータベースの重要な情報をログに記録
  - AIエージェントには削除の影響を明確に伝えること

## 重要な設計要件

### セキュリティと安全性
1. **SQLインジェクション対策**: すべてのクエリでパラメータ化クエリを使用
2. **書き込み制限**: CREATE TABLE, INSERT, SELECT のみ許可
   - DROP, DELETE, UPDATEは基本的に禁止（または厳重な確認が必要）
3. **ファイルシステム隔離**: データベースファイルは専用ディレクトリ内のみに作成
4. **削除操作の安全性**:
   - `delete_database` は2段階確認必須（confirm=true が明示的に必要）
   - 削除前に削除対象の詳細情報をログ出力
   - 削除操作の監査ログを残す

### データベース管理
1. **メタデータ管理**: 各DBに`_metadata`テーブルを自動作成
   ```sql
   CREATE TABLE _metadata (
     key TEXT PRIMARY KEY,
     value TEXT,
     created_at TEXT,
     updated_at TEXT
   )
   ```
   - データベースの目的・説明
   - 作成日時
   - 最終更新日時
   - 作成したテーブルのリスト

2. **スキーマの柔軟性**: AIが調査内容に応じて最適なカラム構成を自由に設計可能

3. **トランザクション**: データ整合性を保証（特に複数行INSERT時）

### エラーハンドリング
1. 既存DBへの上書き防止（警告メッセージを返す）
2. 型不一致エラーの明確なメッセージ
3. 不正なSQL文の検出と拒否
4. ファイル権限エラーの適切な処理

## ディレクトリ構成

```
autonomous-research-mcp/
├── server.py              # MCPサーバーのメイン実装
├── db_operations.py       # データベース操作ロジック
├── research_databases/    # 作成されるDBファイルの保存先
│   └── .gitkeep
├── pyproject.toml         # uv設定
└── README.md              # セットアップと使用方法
```

## 動作例シナリオ

### シナリオ1: テクノロジー企業の市場調査
```
ユーザー: 「GAFAM各社の時価総額を調査してデータベースに保存して」

AIエージェントの動作:
1. create_research_database を呼び出し
   database_name: "tech_giants_2025.db"
   table_schema: {
     "table_name": "companies",
     "columns": {
       "id": "INTEGER PRIMARY KEY AUTOINCREMENT",
       "company_name": "TEXT NOT NULL",
       "ticker": "TEXT",
       "market_cap": "REAL",
       "industry": "TEXT",
       "research_date": "TEXT"
     }
   }
   description: "GAFAM企業の時価総額調査"

2. （Web検索などで調査を実施 ← 別ツール）

3. insert_research_data を呼び出し
   database_name: "tech_giants_2025.db"
   table_name: "companies"
   data: [
     {"company_name": "Apple", "ticker": "AAPL", "market_cap": 3000000000000, ...},
     {"company_name": "Google", "ticker": "GOOGL", "market_cap": 1800000000000, ...},
     ...
   ]

4. query_research_data を呼び出し
   database_name: "tech_giants_2025.db"
   sql_query: "SELECT company_name, market_cap FROM companies ORDER BY market_cap DESC"
   
5. 結果をユーザーに報告
```

### シナリオ2: 既存DBへの追加調査
```
ユーザー: 「昨日作った企業データベースにNetflixとTeslaのデータも追加して」

AIエージェントの動作:
1. list_research_databases で既存DB確認
   → "tech_giants_2025.db" を発見

2. get_table_schema でスキーマ確認
   database_name: "tech_giants_2025.db"
   table_name: "companies"
   → カラム構成を把握

3. （Netflix、Teslaを調査 ← 別ツール）

4. insert_research_data で新データ追加
   database_name: "tech_giants_2025.db"
   table_name: "companies"
   data: [
     {"company_name": "Netflix", ...},
     {"company_name": "Tesla", ...}
   ]
```

### シナリオ3: データベース管理
```
ユーザー: 「今までに作った調査データベースを全部見せて」

AIエージェントの動作:
1. list_all_databases を呼び出し
   → すべてのDBファイルと詳細情報を取得

2. 結果を整形してユーザーに表示:
   「以下の調査データベースが存在します:
   1. tech_giants_2025.db (2.5MB, 2テーブル)
      - 作成: 2025-01-15
      - 説明: GAFAM企業の時価総額調査
   2. competitor_analysis.db (1.2MB, 3テーブル)
      - 作成: 2025-01-10
      - 説明: 競合分析データ
   ...」
```

### シナリオ4: 不要なデータベースの削除
```
ユーザー: 「古い競合分析のデータベースは不要だから削除して」

AIエージェントの動作:
1. list_all_databases で対象DB確認
   → "competitor_analysis.db" を特定

2. delete_database を呼び出し（第1段階）
   database_name: "competitor_analysis.db"
   confirm: false
   → 確認メッセージが返される

3. ユーザーに確認
   「competitor_analysis.db（1.2MB、3テーブル、150レコード）を削除します。
   この操作は取り消せません。本当に削除しますか？」

4. ユーザーが承認後、delete_database を呼び出し（第2段階）
   database_name: "competitor_analysis.db"
   confirm: true
   → データベース削除完了
```

## 実装の開始手順

### 1. プロジェクト初期化
```bash
uv init autonomous-research-mcp
cd autonomous-research-mcp
uv venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
uv add "mcp[cli]"
mkdir research_databases
```

### 2. Claude Desktop設定（参考）
`~/Library/Application Support/Claude/claude_desktop_config.json`:
```json
{
  "mcpServers": {
    "research-db": {
      "command": "uv",
      "args": [
        "--directory",
        "/absolute/path/to/autonomous-research-mcp",
        "run",
        "server.py"
      ]
    }
  }
}
```

### 3. 動作確認
```bash
# MCPインスペクターでテスト
npx @modelcontextprotocol/inspector uv --directory /path/to/autonomous-research-mcp run server.py
```

## 期待される成果物

1. **server.py**: FastMCPを使った完全動作するMCPサーバー
2. **db_operations.py**: データベース操作の実装（クリーンな関数群）
3. **README.md**: 
   - セットアップ手順
   - 使用方法
   - 各ツールの説明と例
   - トラブルシューティング
4. **requirements.txt または pyproject.toml**: 依存関係の明記

## コーディング規約

1. **型ヒント（Type Hints）を完全に使用**
   ```python
   def insert_research_data(
       database_name: str,
       table_name: str,
       data: dict | list[dict]
   ) -> dict[str, Any]:
       ...
   ```

2. **詳細なdocstring**（FastMCPが自動でツール説明に使用）
   ```python
   @mcp.tool()
   def create_research_database(
       database_name: str,
       table_schema: dict,
       description: str
   ) -> str:
       """
       調査結果を保存するための新しいデータベースとテーブルを作成します。
       
       Args:
           database_name: データベースファイル名（拡張子.db不要）
           table_schema: テーブル定義（table_name, columns を含む辞書）
           description: このデータベースの目的説明
           
       Returns:
           作成成功メッセージとデータベースパス
           
       Raises:
           ValueError: スキーマが不正な場合
           FileExistsError: 同名のDBが既に存在する場合
       """
   ```

3. **エラーメッセージはユーザーフレンドリーに**
   ```python
   # ❌ 悪い例
   raise Exception("Error")
   
   # ✅ 良い例
   raise ValueError(
       f"テーブル '{table_name}' は既に存在します。"
       f"別のテーブル名を指定するか、既存テーブルにデータを追加してください。"
   )
   ```

4. **ログ出力で動作追跡可能に**
   ```python
   import logging
   
   logging.info(f"Creating database: {database_name}")
   logging.debug(f"Table schema: {table_schema}")
   ```

## 最終確認事項

このMCPサーバーにより、AIエージェントは:

✅ 調査内容から最適なDBスキーマを自律的に設計できる  
✅ その場でデータベースとテーブルを作成できる  
✅ 調査結果（他ツールで取得）を適切に蓄積できる  
✅ 蓄積したデータをSQL検索・分析できる  
✅ 複数の調査プロジェクトを並行管理できる  
✅ 既存DBに新しいデータを追加できる  
✅ すべてのデータベースを一覧表示できる  
✅ 不要になったデータベースを安全に削除できる  

**調査機能自体は含まれません。データベース操作に特化したMCPサーバーです。**

上記の仕様に基づいて、production-readyなMCPサーバーを実装してください。